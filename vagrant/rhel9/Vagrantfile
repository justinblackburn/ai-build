# Load .env file
File.readlines('.env').each do |line|
  next if line.strip.empty? || line.strip.start_with?('#')
  key, value = line.strip.split('=', 2)
  ENV[key] = value
end

Vagrant.configure("2") do |config|
  config.vm.box = "generic/rhel9"
  config.vm.hostname = "rhel9-vagrant"
  config.vm.network "forwarded_port", guest: 7860, host: 7860
  config.vm.provider "virtualbox" do |vb|
    vb.name = "rhel9-vagrant" # Add this line
    vb.memory = 4096
    vb.cpus = 2
    vb.customize [
      "storageattach", :id,
      "--storagectl", "IDE Controller",
      "--port", "1",
      "--device", "0",
      "--type", "dvddrive",
      "--medium", "../../files/VBoxGuestAdditions_7.1.10.iso"
    ]
  end

  # Share your repo directory (optional)
  config.vm.synced_folder ".", "/vagrant", type: "rsync"
  config.vm.synced_folder "../shared", "/mnt/shared", mount_options: ["dmode=755,fmode=644"]
  config.vm.synced_folder "../../ansible", "/mnt/ansible", mount_options: ["dmode=755,fmode=644"]
  config.vm.synced_folder "../../files", "/mnt/files", mount_options: ["dmode=755,fmode=644"]

  # Persistent Python wheel cache for air-gap testing
  config.vm.synced_folder "../shared/wheels", "/mnt/wheels",
    create: true,
    mount_options: ["dmode=755,fmode=644"]

  # Register with Red Hat Subscription Manager using activation key and org
  config.vm.provision "shell",
    env: {
      RHSM_ORG: ENV['RHSM_ORG'],
      RHSM_KEY: ENV['RHSM_KEY']
    },
    inline: <<-SHELL
      echo "Registering system with Red Hat using activation key..."
      echo "Org: ${RHSM_ORG}"
      echo "Activation Key: ${RHSM_KEY}"
      subscription-manager register \
        --org="${RHSM_ORG}" \
        --activationkey="${RHSM_KEY}" || echo "Registration failed"
      # Skip full update to avoid downloading 659MB linux-firmware
      # dnf update -y
      dnf install -y ansible git --skip-broken

      # Link /tmp/wheels to persistent shared location
      echo "Setting up persistent wheel cache..."
      rm -rf /tmp/wheels
      ln -sf /mnt/wheels /tmp/wheels
      echo "Wheel cache linked: /tmp/wheels -> /mnt/wheels"

      # Link /srv/rag/wheels to persistent shared location for RAG stack
      mkdir -p /srv/rag
      rm -rf /srv/rag/wheels
      ln -sf /mnt/wheels /srv/rag/wheels
      echo "RAG wheel cache linked: /srv/rag/wheels -> /mnt/wheels"
SHELL

end
